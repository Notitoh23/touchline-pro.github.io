<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Touchline Pro</title>
  <!-- Attractive Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
   body { 
    font-family: 'Poppins', sans-serif;
      background-image: url('trot.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      position: relative;
    }
    /* Semi-transparent overlay to improve text readability */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      z-index: -1;
    }
    .logo {
      font-family: 'Poppins', sans-serif;
      @apply text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-700 to-blue-600 flex items-center;
    }
    .card {
      @apply bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-100 transform transition hover:shadow-xl hover:scale-105;
    }
    .btn {
      @apply px-5 py-2.5 rounded-lg font-medium cursor-pointer inline-block text-center transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2
    }
    .btn-blue {
      @apply btn bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 focus:ring-blue-500;
    }
    .btn-green {
      @apply btn bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700 focus:ring-green-500;
    }
    .btn-red {
      @apply btn bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 focus:ring-red-500;
    }
    .btn-yellow {
      @apply btn bg-gradient-to-r from-yellow-500 to-yellow-600 text-white hover:from-yellow-600 hover:to-yellow-700 focus:ring-yellow-500;
    }
    .status-full {
      @apply inline-block px-3 py-1.5 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-200;
    }
    .status-partial {
      @apply inline-block px-3 py-1.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200;
    }
    .status-expired {
      @apply inline-block px-3 py-1.5 text-xs font-semibold rounded-full bg-red-100 text-red-800 border border-red-200;
    }
    input, select, textarea {
      @apply p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200 shadow-sm;
    }
    table {
      @apply w-full text-sm rounded-lg overflow-hidden;
    }
    th {
      @apply font-semibold text-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 p-4 text-left;
    }
    td {
      @apply p-4 border-t border-gray-100;
    }
    .alert-warning {
      @apply p-5 mb-6 bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200 rounded-xl text-orange-800 flex items-center shadow-md;
    }
    .alert-warning i {
      @apply w-6 h-6 mr-3 text-orange-500;
    }
    .tab-btn {
      @apply px-8 py-3 font-semibold rounded-t-lg transition hover:bg-gray-100 text-gray-600;
    }
    .tab-active {
      @apply bg-white border-b-4 border-green-500 text-green-700 font-bold shadow-sm;
    }
    .grid > div {
      @apply transform transition-all duration-300 hover:scale-105;
    }
    h2 {
      @apply text-2xl font-semibold text-gray-800 mb-5 flex items-center;
    }
    h2 i {
      @apply mr-2 w-6 h-6 text-green-600;
    }
    .bottom-nav {
      @apply fixed bottom-0 left-0 right-0 bg-white shadow-md p-2 flex justify-around items-center;
    }
    .nav-icon {
      @apply text-2xl text-gray-600;
    }
    .nav-icon.active {
      @apply text-green-600;
    }
    .player-card {
      @apply p-4 border border-gray-200 rounded-lg mb-3 bg-white hover:shadow-md transition;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <div class="container mx-auto px-6 py-8 max-w-6xl mb-16">
    <header class="mb-8">
      <h1 class="logo mb-1">
        TOUCHLINE PRO. <span class="text-sm font-normal text-gray-600 ml-2">developed by Notitoh</span>
      </h1>
      <p class="text-center text-gray-600 mb-8 text-lg">Professional Club Management System</p>
      <!-- Currency Selector -->
      <div class="flex justify-end mb-6">
        <label class="flex items-center text-gray-700 font-medium">
          Currency: 
          <select id="currency-select" class="ml-2 p-2 border border-gray-300 rounded-lg bg-white shadow-sm">
            <option value="USD">USD</option>
            <option value="ZMW">ZMW</option>
          </select>
        </label>
      </div>
    </header>
    <!-- Tabs -->
    <div class="flex border-b-2 border-gray-200 mb-8 space-x-4">
      <button data-tab="dashboard" class="tab-btn tab-active">Dashboard</button>
      <button data-tab="players" class="tab-btn">Players</button>
      <button data-tab="fees" class="tab-btn">Fees Setup</button>
      <button data-tab="attendance" class="tab-btn">Attendance</button>
    </div>
    <!-- Dashboard -->
    <div id="view-dashboard" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card text-center bg-gradient-to-br from-green-50 to-green-100 border-green-200 cursor-pointer hover:bg-green-200" id="dashboard-total">
          <h3 class="text-3xl font-bold text-green-700" id="total-players">0</h3>
          <p class="text-green-800 font-medium">Total Players</p>
        </div>
        <div class="card text-center bg-gradient-to-br from-green-50 to-emerald-100 border-emerald-200 cursor-pointer hover:bg-emerald-200" id="dashboard-full">
          <h3 class="text-3xl font-bold text-emerald-700" id="full-players">0</h3>
          <p class="text-emerald-800 font-medium">Fully Registered</p>
        </div>
        <div class="card text-center bg-gradient-to-br from-yellow-50 to-amber-100 border-amber-200 cursor-pointer hover:bg-amber-200" id="dashboard-partial">
          <h3 class="text-3xl font-bold text-amber-700" id="partial-players">0</h3>
          <p class="text-amber-800 font-medium">Partially Paid</p>
        </div>
        <div class="card text-center bg-gradient-to-br from-red-50 to-rose-100 border-rose-200 cursor-pointer hover:bg-rose-200" id="dashboard-expired">
          <h3 class="text-3xl font-bold text-rose-700" id="expired-players">0</h3>
          <p class="text-rose-800 font-medium">Expired</p>
        </div>
      </div>
      <div class="card">
        <h2><i data-lucide="calendar"></i> Upcoming Expirations (Next 30 Days)</h2>
        <div id="expiring-soon" class="text-gray-700 mt-3">No players expiring soon.</div>
      </div>
    </div>
    <!-- Players -->
    <div id="view-players" class="tab-content hidden">
      <div class="card">
        <h2><i data-lucide="user-plus"></i> Add Player</h2>
        <input type="text" id="player-name" placeholder="Player Full Name" />
        <select id="player-age-group"></select>
        <input type="date" id="registration-date" />
        <label class="font-medium">Fees Paid:</label>
        <div id="fee-checkboxes"></div>
        <button id="add-player" class="btn-blue mt-5 w-full md:w-auto">Save Player</button>
      </div>
      <div class="flex justify-between items-center mb-4">
        <h2><i data-lucide="users"></i> All Players</h2>
        <button id="export-players-excel" class="btn-green">
          📊 Export Players to Excel
        </button>
      </div>
      <input type="text" id="search-player" class="mb-4" placeholder="🔍 Search players..." />
      <div id="players-list"></div>
    </div>
    <!-- Fees Setup -->
    <div id="view-fees" class="tab-content hidden">
      <div class="card">
        <h2><i data-lucide="ZMW"></i> Registration Fees</h2>
        <p class="text-gray-600 mb-5">Define what players must pay to register and how long each payment lasts.</p>
        <div id="fees-list"></div>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="add-fee" class="btn-blue">+ Add Fee Item</button>
          <button class="btn-green save-all">💾 Save Changes</button>
          <button class="btn-red discard-all">🗑️ Discard Changes</button>
        </div>
      </div>
      <div class="card mt-6">
        <h2><i data-lucide="users"></i> Age Groups</h2>
        <p class="text-gray-600 mb-5">Set age groups for your club.</p>
        <div id="age-groups"></div>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="add-age-group" class="btn-blue">+ Add Age Group</button>
          <button class="btn-green save-all">💾 Save Changes</button>
          <button class="btn-red discard-all">🗑️ Discard Changes</button>
        </div>
      </div>
    </div>
    <!-- Attendance -->
    <div id="view-attendance" class="tab-content hidden">
      <div class="card">
        <h2><i data-lucide="clipboard"></i> Attendance List</h2>
        <p class="text-gray-600 mb-5">Mark attendance for training sessions.</p>
        <input type="date" id="session-date" value="" class="mb-5" />
        <div id="attendance-list"></div>
        <button id="save-attendance" class="btn-blue mt-5 w-full md:w-auto">Save Attendance</button>
      </div>
    </div>
  </div>
  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="#dashboard" class="nav-icon" data-nav="dashboard"><i data-lucide="home"></i></a>
    <a href="#players" class="nav-icon" data-nav="players"><i data-lucide="users"></i></a>
    <a href="#fees" class="nav-icon" data-nav="fees"><i data-lucide="dollar-sign"></i></a>
    <a href="#attendance" class="nav-icon" data-nav="attendance"><i data-lucide="clipboard"></i></a>
  </nav>
  <script>
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    // Default data
    const defaultFees = [
      { id: 1, name: 'Registration Fee', amount: '2000', duration: 90 },
      { id: 2, name: 'Kit fee', amount: '2420', duration: 0 }
    ];
    const defaultAgeGroups = [
      { id: 1, name: 'U-13', min: 10, max: 13 },
      { id: 2, name: 'U-15', min: 13, max: 15 },
      { id: 3, name: 'U-17', min: 15, max: 17 },
      { id: 4, name: 'U-19', min: 17, max: 19 }
    ];
    // Load from localStorage
    function safeGet(key, fallback) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : fallback;
      } catch (e) {
        console.warn('Could not load ' + key, e);
        return fallback;
      }
    }
    let fees = safeGet('touchlinepro-fees', defaultFees);
    let ageGroups = safeGet('touchlinepro-age-groups', defaultAgeGroups);
    let players = safeGet('touchlinepro-players', []);
    let attendance = safeGet('touchlinepro-attendance', {});
    // Save function
    function saveData() {
      try {
        localStorage.setItem('touchlinepro-fees', JSON.stringify(fees));
        localStorage.setItem('touchlinepro-age-groups', JSON.stringify(ageGroups));
        localStorage.setItem('touchlinepro-players', JSON.stringify(players));
        localStorage.setItem('touchlinepro-attendance', JSON.stringify(attendance));
        showSuccess("Changes saved successfully!");
      } catch (e) {
        alert("Failed to save data. Please ensure your browser allows localStorage.");
        console.error("localStorage error:", e);
      }
    }
    // Success message
    function showSuccess(msg) {
      const alertBox = document.createElement('div');
      alertBox.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      alertBox.textContent = msg;
      document.body.appendChild(alertBox);
      setTimeout(() => alertBox.remove(), 3000);
    }
    // === TABS ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('border-b-4', 'border-green-500', 'text-green-700', 'font-bold');
          b.classList.add('text-gray-600');
        });
        const tab = btn.getAttribute('data-tab');
        document.getElementById('view-' + tab).classList.remove('hidden');
        btn.classList.add('border-b-4', 'border-green-500', 'text-green-700', 'font-bold');
        // Refresh content
        if (tab === 'players') renderFeeCheckboxes(); renderPlayers();
        if (tab === 'attendance') renderAttendanceList();
        if (tab === 'dashboard') updateDashboard();
      });
    });
    // Bottom Nav
    document.querySelectorAll('[data-nav]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const tab = link.getAttribute('data-nav');
        document.querySelector(`[data-tab="${tab}"]`).click();
      });
    });
    // === DASHBOARD INTERACTIVITY ===
    document.getElementById('dashboard-total')?.addEventListener('click', () => {
      switchToPlayersTab('all');
    });
    document.getElementById('dashboard-full')?.addEventListener('click', () => {
      switchToPlayersTab('full');
    });
    document.getElementById('dashboard-partial')?.addEventListener('click', () => {
      switchToPlayersTab('partial');
    });
    document.getElementById('dashboard-expired')?.addEventListener('click', () => {
      switchToPlayersTab('expired');
    });
    function switchToPlayersTab(filter) {
      // Switch to players tab
      document.querySelector('[data-tab="players"]').click();
      // Set the filter
      document.getElementById('search-player').value = '';
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('filter-active');
        if (btn.getAttribute('data-filter') === filter) {
          btn.classList.add('filter-active');
        }
      });
      // Update players list
      renderPlayers(filter);
    }
    // === FEES: Render & Events ===
    function renderFees() {
      const list = document.getElementById('fees-list');
      if (!list) return;
      list.innerHTML = '';
      fees.forEach(fee => {
        list.innerHTML += `
          <div class="flex flex-col sm:flex-row items-center gap-3 mb-3 p-3 bg-gray-50 rounded-xl fee-item" data-id="${fee.id}">
            <input type="text" value="${fee.name}" class="fee-name flex-grow" />
            <input type="number" value="${fee.amount}" class="fee-amount w-full sm:w-24" />
            <select class="fee-duration w-full sm:w-32">
              <option value="7" ${fee.duration === 7 ? 'selected' : ''}>7 days</option>
              <option value="30" ${fee.duration === 30 ? 'selected' : ''}>30 days</option>
              <option value="90" ${fee.duration === 90 ? 'selected' : ''}>90 days</option>
              <option value="180" ${fee.duration === 180 ? 'selected' : ''}>180 days</option>
              <option value="365" ${fee.duration === 365 ? 'selected' : ''}>1 year</option>
              <option value="0" ${fee.duration === 0 ? 'selected' : ''}>Once off</option>
            </select>
            <button class="btn-red delete-fee">Delete</button>
          </div>`;
      });
    }
    // Add new fee
    document.getElementById('add-fee')?.addEventListener('click', () => {
      const newId = Date.now();
      fees.push({
        id: newId,
        name: 'New Fee',
        amount: '0',
        duration: 30
      });
      saveData();
      renderFees();
    });
    // Delete fee
    document.getElementById('fees-list')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-fee')) {
        const id = parseInt(e.target.closest('.fee-item').getAttribute('data-id'));
        fees = fees.filter(f => f.id !== id);
        saveData();
        renderFees();
      }
    });
    // Save fee edits
    document.getElementById('fees-list')?.addEventListener('change', (e) => {
      const item = e.target.closest('.fee-item');
      if (!item) return;
      const id = parseInt(item.getAttribute('data-id'));
      const fee = fees.find(f => f.id === id);
      if (!fee) return;
      if (e.target.classList.contains('fee-name')) fee.name = e.target.value;
      if (e.target.classList.contains('fee-amount')) fee.amount = e.target.value;
      if (e.target.classList.contains('fee-duration')) {
        fee.duration = parseInt(e.target.value);
      }
      saveData();
    });
    // === AGE GROUPS: Render & Events ===
    function renderAgeGroups() {
      const list = document.getElementById('age-groups');
      if (!list) return;
      list.innerHTML = '';
      ageGroups.forEach(group => {
        list.innerHTML += `
          <div class="flex flex-col sm:flex-row items-center gap-3 mb-3 p-3 bg-gray-50 rounded-xl age-group" data-id="${group.id}">
            <input type="text" value="${group.name}" class="age-name w-full sm:w-1/3" />
            <span class="mx-1 text-gray-500">Ages</span>
            <input type="number" value="${group.min}" class="age-min w-20" />
            <span class="mx-1 text-gray-500">to</span>
            <input type="number" value="${group.max}" class="age-max w-20" />
            <button class="btn-red delete-age-group">Delete</button>
          </div>`;
      });
    }
    // Add new age group
    document.getElementById('add-age-group')?.addEventListener('click', () => {
      const newId = Date.now();
      ageGroups.push({
        id: newId,
        name: 'U-X',
        min: 0,
        max: 20
      });
      saveData();
      renderAgeGroups();
    });
    // Delete age group
    document.getElementById('age-groups')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-age-group')) {
        const id = parseInt(e.target.closest('.age-group').getAttribute('data-id'));
        ageGroups = ageGroups.filter(g => g.id !== id);
        saveData();
        renderAgeGroups();
      }
    });
    // Save age group edits
    document.getElementById('age-groups')?.addEventListener('change', (e) => {
      const item = e.target.closest('.age-group');
      if (!item) return;
      const id = parseInt(item.getAttribute('data-id'));
      const group = ageGroups.find(g => g.id === id);
      if (!group) return;
      if (e.target.classList.contains('age-name')) group.name = e.target.value;
      if (e.target.classList.contains('age-min')) group.min = e.target.value;
      if (e.target.classList.contains('age-max')) group.max = e.target.value;
      saveData();
    });
    // === AGE GROUP Dropdown ===
    function renderAgeDropdown() {
      const select = document.getElementById('player-age-group');
      if (!select) return;
      select.innerHTML = '<option value="">Select Age Group</option>';
      ageGroups.forEach(g => {
        select.innerHTML += `<option value="${g.name}">${g.name}</option>`;
      });
    }
    // === FEE CHECKBOXES ===
    function renderFeeCheckboxes() {
      const container = document.getElementById('fee-checkboxes');
      if (!container) return;
      container.innerHTML = '<p class="mb-3 font-medium text-gray-700">Select Fees Paid:</p>';
      fees.forEach(fee => {
        container.innerHTML += `
          <label class="flex items-center mb-2.5 text-gray-700">
            <input type="checkbox" data-fee="${fee.name}" data-duration="${fee.duration}" class="mr-3 w-5 h-5 text-blue-600 rounded focus:ring-blue-500 fee-checkbox">
            <span>${fee.name} ($${fee.amount}) ${fee.duration > 0 ? `- lasts ${formatDuration(fee.duration)}` : ''}</span>
          </label>`;
      });
    }
    function formatDuration(days) {
      if (days === 7) return '7 days';
      if (days === 30) return '1 month';
      if (days === 90) return '3 months';
      if (days === 180) return '6 months';
      if (days === 365) return '1 year';
      if (days === 0) return 'Once off';
      return `${days} days`;
    }
    // === ADD PLAYER ===
    document.getElementById('add-player')?.addEventListener('click', () => {
      const name = document.getElementById('player-name').value;
      if (!name) return alert("Player name is required");
      const ageGroup = document.getElementById('player-age-group').value;
      const regDateStr = document.getElementById('registration-date').value || new Date().toISOString().split('T')[0];
      const regDate = new Date(regDateStr);
      const paidFees = {};
      let maxExpiry = new Date(regDate);
      // Process fees
      document.querySelectorAll('.fee-checkbox:checked').forEach(cb => {
        const feeName = cb.getAttribute('data-fee');
        const fee = fees.find(f => f.name === feeName);
        if (fee && fee.duration > 0) {
          paidFees[feeName] = true;
          // Extend expiry date only for fees with duration > 0
          const expiry = new Date(regDate);
          expiry.setDate(expiry.getDate() + fee.duration);
          if (expiry > maxExpiry) {
            maxExpiry = expiry;
          }
        } else if (fee && fee.duration === 0) {
          paidFees[feeName] = true; // Mark as paid but don't extend expiry
        }
      });
      const expiryDate = maxExpiry.toISOString().split('T')[0];
      players.push({
        id: Date.now(),
        name,
        ageGroup,
        regDate: regDateStr,
        expiryDate,
        paidFees
      });
      saveData();
      renderPlayers();
      updateDashboard();
      alert("Player added!");
      document.getElementById('player-name').value = '';
    });
    // === RENDER PLAYERS ===
    function renderPlayers(filter = 'all') {
      const container = document.getElementById('players-list');
      if (!container) return;
      const search = document.getElementById('search-player')?.value.toLowerCase() || '';
      container.innerHTML = '';
      players
        .filter(p => {
          // Apply filter
          if (filter === 'all') return true;
          const status = getPlayerStatus(p);
          if (filter === 'full') return status === 'Fully Registered';
          if (filter === 'partial') return status === 'Partially Paid';
          if (filter === 'expired') return status === 'Expired';
          return true;
        })
        .filter(p => p.name.toLowerCase().includes(search))
        .forEach(p => {
          const status = getPlayerStatus(p);
          const today = new Date();
          const exp = new Date(p.expiryDate);
          const isExpired = exp < today;
          const hasPaidKit = p.paidFees['Kit fee'];
          const hasPaidRegistration = p.paidFees['Registration Fee'];
          const isPartiallyPaid = !isExpired && (!hasPaidRegistration || !hasPaidKit);
          const isFullyRegistered = !isExpired && hasPaidRegistration && hasPaidKit;
          
          let actionButton = '';
          if (isExpired) {
            actionButton = `<button data-id="${p.id}" class="btn-blue text-sm px-3 py-1.5 renew-player">Renew</button>`;
          } else if (isPartiallyPaid) {
            actionButton = `<button data-id="${p.id}" class="btn-green text-sm px-3 py-1.5 complete-payment">Complete Payment</button>`;
          } else {
            actionButton = `<button data-id="${p.id}" class="btn-blue text-sm px-3 py-1.5 renew-player">Renew</button>`;
          }
          
          container.innerHTML += `
            <div class="player-card">
              <div class="flex justify-between">
                <div>
                  <h3 class="font-bold">${p.name}</h3>
                  <p class="text-sm text-gray-600">${p.ageGroup} • Expires: ${p.expiryDate}</p>
                  <span class="status-${status.toLowerCase().replace(' ', '-')}">${status}</span>
                </div>
                <div class="flex gap-2">
                  ${actionButton}
                  <button data-id="${p.id}" class="btn-red text-sm px-3 py-1.5 delete-player">Delete</button>
                </div>
              </div>
            </div>`;
        });
    }
    
    // Check if all fees are paid
    function allFeesPaid(player) {
      return fees.every(fee => player.paidFees[fee.name]);
    }
    
    // Get Player Status
    function getPlayerStatus(player) {
      const today = new Date();
      const exp = new Date(player.expiryDate);
      if (exp < today) return 'Expired';
      const hasPaidKit = player.paidFees['Kit fee'];
      const hasPaidRegistration = player.paidFees['Registration Fee'];
      if (!hasPaidRegistration || !hasPaidKit) return 'Partially Paid';
      const diffTime = exp - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays <= 30) return 'Partial';
      return 'Fully Registered';
    }
    
    // Renew Player
    document.addEventListener('click', (e) => {
      // Renew button
      if (e.target.classList.contains('renew-player')) {
        const id = e.target.getAttribute('data-id');
        const player = players.find(p => p.id == id);
        if (player) {
          // Fill the add player form with player's name
          document.getElementById('player-name').value = player.name;
          document.getElementById('player-age-group').value = player.ageGroup;
          // Reset checkboxes
          document.querySelectorAll('.fee-checkbox').forEach(cb => {
            cb.checked = false;
          });
          // Pre-check Kit fee if already paid
          if (player.paidFees['Kit fee']) {
            document.querySelectorAll('.fee-checkbox').forEach(cb => {
              if (cb.getAttribute('data-fee') === 'Kit fee') {
                cb.checked = true;
              }
            });
          }
          // Switch to players tab
          document.querySelector('[data-tab="players"]').click();
          // Scroll to add player section
          document.getElementById('player-name').scrollIntoView({behavior: 'smooth'});
          document.getElementById('player-name').focus();
        }
      }
      // Complete payment button
      else if (e.target.classList.contains('complete-payment')) {
        const id = e.target.getAttribute('data-id');
        const player = players.find(p => p.id == id);
        if (player) {
          // Mark all fees as paid
          fees.forEach(fee => {
            player.paidFees[fee.name] = true;
          });
          
          // Extend expiry date (only for registration fee since kit fee has no duration)
          const today = new Date();
          let maxExpiry = new Date(today);
          const registrationFee = fees.find(f => f.name === 'Registration Fee');
          if (registrationFee && registrationFee.duration > 0) {
            const expiry = new Date(today);
            expiry.setDate(expiry.getDate() + registrationFee.duration);
            maxExpiry = expiry;
          }
          player.expiryDate = maxExpiry.toISOString().split('T')[0];
          
          saveData();
          renderPlayers();
          updateDashboard();
          alert(`${player.name} has been fully registered!`);
        }
      }
      // Delete Player
      else if (e.target.classList.contains('delete-player')) {
        if (confirm("Delete this player?")) {
          const id = e.target.getAttribute('data-id');
          players = players.filter(p => p.id != id);
          saveData();
          renderPlayers();
          updateDashboard();
        }
      }
    });
    
    // === DASHBOARD UPDATES ===
    function updateDashboard() {
      const totalPlayers = players.length;
      let fullCount = 0;
      let partialCount = 0;
      let expiredCount = 0;
      
      players.forEach(player => {
        const status = getPlayerStatus(player);
        if (status === 'Fully Registered') fullCount++;
        else if (status === 'Partially Paid') partialCount++;
        else if (status === 'Expired') expiredCount++;
      });
      
      document.getElementById('total-players').textContent = totalPlayers;
      document.getElementById('full-players').textContent = fullCount;
      document.getElementById('partial-players').textContent = partialCount;
      document.getElementById('expired-players').textContent = expiredCount;
      
      checkExpiryAlerts();
    }
    
    // Check Expiry Alerts
    function checkExpiryAlerts() {
      const today = new Date();
      const soon = new Date();
      soon.setDate(soon.getDate() + 30);
      const expiring = players.filter(p => {
        if (!p.expiryDate) return false;
        const exp = new Date(p.expiryDate);
        return exp > today && exp <= soon;
      });
      
      const expiringList = document.getElementById('expiring-soon');
      if (expiringList) {
        if (expiring.length > 0) {
          expiringList.innerHTML = '';
          expiring.forEach(p => {
            const exp = new Date(p.expiryDate);
            const diffTime = exp - new Date();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            expiringList.innerHTML += `<div class="font-medium">${p.name} (${p.ageGroup}) – Expires in ${diffDays} days</div>`;
          });
        } else {
          expiringList.textContent = "No players expiring soon.";
        }
      }
    }
    // === ATTENDANCE ===
    function renderAttendanceList() {
      const list = document.getElementById('attendance-list');
      const date = document.getElementById('session-date')?.value;
      if (!list) return;
      if (!date) {
        list.innerHTML = '<p class="text-gray-600">Select a date to mark attendance.</p>';
        return;
      }
      list.innerHTML = '';
      players.forEach(p => {
        const present = attendance[date]?.includes(p.id) || false;
        list.innerHTML += `
          <label class="flex items-center mb-3 p-2 hover:bg-gray-50 rounded-lg transition">
            <input type="checkbox" class="mr-3 w-5 h-5 text-green-600 rounded focus:ring-green-500 att-checkbox" data-id="${p.id}" ${present ? 'checked' : ''}>
            <span>${p.name} <span class="text-gray-500">(${p.ageGroup})</span></span>
          </label>`;
      });
    }
    document.getElementById('session-date')?.addEventListener('change', renderAttendanceList);
    document.getElementById('save-attendance')?.addEventListener('click', () => {
      const date = document.getElementById('session-date').value;
      const checked = Array.from(document.querySelectorAll('.att-checkbox:checked')).map(cb => parseInt(cb.getAttribute('data-id')));
      attendance[date] = checked;
      saveData();
      alert("Attendance saved!");
    });
    // === SAVE ALL BUTTONS (using class) ===
    document.querySelectorAll('.save-all').forEach(btn => {
      btn.addEventListener('click', () => {
        saveData();
        alert("All changes have been saved successfully!");
      });
    });
    document.querySelectorAll('.discard-all').forEach(btn => {
      btn.addEventListener('click', () => {
        renderFees();
        renderAgeGroups();
        showSuccess("Changes discarded.");
      });
    });
    
    // === EXCEL EXPORT FUNCTIONALITY ===
    function exportToExcel(data, filename) {
      // Create worksheet from data
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Create workbook and add worksheet
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Players");
      
      // Export file
      XLSX.writeFile(wb, filename);
    }
    
    // Export all players to Excel
    document.getElementById('export-excel')?.addEventListener('click', () => {
      if (players.length === 0) {
        alert("No players to export!");
        return;
      }
      
      // Prepare data for export
      const exportData = players.map(player => {
        // Create fee columns
        const feeData = {};
        fees.forEach(fee => {
          feeData[fee.name] = player.paidFees[fee.name] ? 'Paid' : 'Not Paid';
        });
        
        return {
          'Name': player.name,
          'Age Group': player.ageGroup,
          'Registration Date': player.regDate,
          'Expiry Date': player.expiryDate,
          'Status': getPlayerStatus(player),
          ...feeData
        };
      });
      
      // Export to Excel
      exportToExcel(exportData, `players_export_${new Date().toISOString().split('T')[0]}.xlsx`);
      showSuccess("Players exported to Excel successfully!");
    });
    
    // Export players from players tab to Excel
    document.getElementById('export-players-excel')?.addEventListener('click', () => {
      if (players.length === 0) {
        alert("No players to export!");
        return;
      }
      
      // Prepare data for export
      const exportData = players.map(player => {
        // Create fee columns
        const feeData = {};
        fees.forEach(fee => {
          feeData[fee.name] = player.paidFees[fee.name] ? 'Paid' : 'Not Paid';
        });
        
        return {
          'Name': player.name,
          'Age Group': player.ageGroup,
          'Registration Date': player.regDate,
          'Expiry Date': player.expiryDate,
          'Status': getPlayerStatus(player),
          ...feeData
        };
      });
      
      // Export to Excel
      exportToExcel(exportData, `players_export_${new Date().toISOString().split('T')[0]}.xlsx`);
      showSuccess("Players exported to Excel successfully!");
    });
    
    // === INITIALIZE ===
    renderFees();
    renderAgeGroups();
    renderAgeDropdown();
    renderFeeCheckboxes();
    renderPlayers();
    renderAttendanceList();
    updateDashboard();
    // Auto-refresh dashboard on tab
    document.querySelector('[data-tab="dashboard"]')?.addEventListener('click', updateDashboard);
  </script>
</body>
</html>